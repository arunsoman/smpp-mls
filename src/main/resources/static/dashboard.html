<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMPP-MLS Admin Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: radial-gradient(ellipse at top, #1e1b4b 0%, #0f172a 50%);
            color: #e2e8f0;
            min-height: 100vh;
            padding: 20px;
        }

        .container { max-width: 1800px; margin: 0 auto; }

        /* Header with animated gradient */
        header {
            background: linear-gradient(270deg, #667eea, #764ba2, #f093fb);
            background-size: 600% 600%;
            animation: gradient 15s ease infinite;
            padding: 40px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 20px 60px rgba(102, 126, 234, 0.4);
        }

        @keyframes gradient {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        h1 { font-size: 36px; font-weight: 800; margin-bottom: 8px; }
        header p { opacity: 0.9; font-size: 15px; }

        /* Unified card styling */
        .card {
            background: rgba(30, 41, 59, 0.5);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card:hover {
            transform: translateY(-2px);
            border-color: rgba(255, 255, 255, 0.2);
            box-shadow: 0 12px 48px rgba(0, 0, 0, 0.4);
        }

        /* Grid layouts */
        .grid { display: grid; gap: 20px; margin-bottom: 30px; }
        .grid-4 { grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); }
        .grid-2 { grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); }

        /* Stats cards with accent bars */
        .stat {
            position: relative;
            overflow: hidden;
        }

        .stat::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--accent);
            transform: scaleX(0);
            transition: transform 0.3s;
        }

        .stat:hover::after { transform: scaleX(1); }

        .stat-label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #94a3b8;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .stat-value {
            font-size: 40px;
            font-weight: 800;
            line-height: 1;
            margin-bottom: 8px;
        }

        .stat-info {
            font-size: 13px;
            color: #cbd5e1;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Chart container */
        .chart { position: relative; height: 280px; }
        .chart canvas { max-height: 280px; }

        /* Sessions */
        .session {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 20px;
        }

        .session-badge {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .session-badge.active {
            background: #10b981;
            box-shadow: 0 0 20px #10b981;
            animation: pulse 2s infinite;
        }

        .session-badge.inactive { background: #ef4444; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .session-info { flex: 1; }
        .session-name { font-size: 16px; font-weight: 600; margin-bottom: 8px; }
        .session-metrics {
            display: flex;
            gap: 16px;
            font-size: 13px;
            color: #94a3b8;
        }

        .session-metrics span { font-weight: 600; color: #e2e8f0; }

        /* Buttons */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-start { background: #10b981; color: white; }
        .btn-start:hover:not(:disabled) { background: #059669; transform: scale(1.05); }
        .btn-stop { background: #ef4444; color: white; }
        .btn-stop:hover:not(:disabled) { background: #dc2626; transform: scale(1.05); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Table */
        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: rgba(51, 65, 85, 0.5);
            padding: 14px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #94a3b8;
        }

        td {
            padding: 14px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 14px;
        }

        tbody tr:hover { background: rgba(99, 102, 241, 0.1); }

        /* Status badges */
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-success { background: rgba(16, 185, 129, 0.2); color: #10b981; }
        .badge-warning { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
        .badge-danger { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .badge-info { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }

        /* Alerts */
        .alert {
            padding: 16px 20px;
            border-radius: 12px;
            margin-bottom: 12px;
            border-left: 3px solid;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .alert-warning {
            border-color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
        }

        .alert-error {
            border-color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }

        .alert strong { display: block; margin-bottom: 4px; }
        .alert small { color: #94a3b8; }

        /* Refresh indicator */
        .refresh {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(30, 41, 59, 0.9);
            backdrop-filter: blur(10px);
            padding: 10px 16px;
            border-radius: 10px;
            font-size: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 100;
        }

        .refresh.active { background: #10b981; color: white; }

        /* Responsive */
        @media (max-width: 768px) {
            .grid-2, .grid-4 { grid-template-columns: 1fr; }
            .session { flex-direction: column; align-items: flex-start; }
            h1 { font-size: 28px; }
        }

        /* Title styling */
        h2 {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 20px;
            color: #e2e8f0;
        }

        /* Loading state */
        .loading { opacity: 0.5; pointer-events: none; }

        /* Toast notifications */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 16px 24px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            color: white;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
            max-width: 400px;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast-success {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .toast-error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .toast-info {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }
    </style>
</head>
<body>
<div class="refresh" id="refresh">Last updated: Never</div>

<div class="container">
    <header>
        <h1>📊 SMPP-MLS Dashboard</h1>
        <p>Real-time monitoring for Afghan SMPP Gateway</p>
    </header>

    <div id="alerts"></div>

    <!-- Stats -->
    <div class="grid grid-4" id="stats"></div>

    <!-- Charts -->
    <div class="grid grid-2">
        <div class="card">
            <h2>Throughput</h2>
            <div class="chart"><canvas id="throughputChart"></canvas></div>
        </div>
        <div class="card">
            <h2>Status Distribution</h2>
            <div class="chart"><canvas id="statusChart"></canvas></div>
        </div>
    </div>

    <!-- Per-Operator Performance Metrics -->
    <h2 style="margin: 20px 0; font-size: 20px; font-weight: 700;">Per-Operator Performance (1h vs 5m Trend)</h2>
    
    <div class="grid grid-2">
        <div class="card">
            <h2>Success Rate (%)</h2>
            <div class="chart"><canvas id="successRateChart"></canvas></div>
        </div>
        <div class="card">
            <h2>Retry Rate (%)</h2>
            <div class="chart"><canvas id="retryRateChart"></canvas></div>
        </div>
        <div class="card">
            <h2>Submit Delay (ms)</h2>
            <div class="chart"><canvas id="submitDelayChart"></canvas></div>
        </div>
        <div class="card">
            <h2>DR Delay (ms)</h2>
            <div class="chart"><canvas id="drDelayChart"></canvas></div>
        </div>
    </div>

    <!-- Sessions -->
    <div class="card" style="margin-bottom: 30px;">
        <h2>Active Sessions</h2>
        <div id="sessions"></div>
    </div>

    <!-- Activity -->
    <div class="card">
        <h2>Recent Activity</h2>
        <table>
            <thead>
            <tr>
                <th>ID</th>
                <th>Phone</th>
                <th>Priority</th>
                <th>Status</th>
                <th>Operator</th>
                <th>Session</th>
                <th>Created</th>
            </tr>
            </thead>
            <tbody id="activity"></tbody>
        </table>
    </div>
</div>

<script>
    const API = '/api/admin';
    let charts = {};

    // Chart config
    const chartConfig = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                labels: { color: '#e2e8f0', font: { size: 11 }, padding: 12 }
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                grid: { color: 'rgba(255,255,255,0.05)' },
                ticks: { color: '#94a3b8', font: { size: 10 } },
                border: { display: false }
            },
            x: {
                grid: { color: 'rgba(255,255,255,0.05)' },
                ticks: { color: '#94a3b8', font: { size: 10 } },
                border: { display: false }
            }
        }
    };

    // Init charts
    charts.throughput = new Chart(document.getElementById('throughputChart'), {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                data: [],
                borderColor: '#6366f1',
                backgroundColor: 'rgba(99, 102, 241, 0.1)',
                tension: 0.4,
                fill: true,
                borderWidth: 2,
                pointRadius: 0
            }]
        },
        options: { 
            ...chartConfig, 
            plugins: { legend: { display: false } },
            scales: {
                ...chartConfig.scales,
                y: {
                    ...chartConfig.scales.y,
                    title: {
                        display: true,
                        text: 'Messages',
                        color: '#94a3b8',
                        font: { size: 11, weight: 'bold' }
                    }
                },
                x: {
                    ...chartConfig.scales.x,
                    title: {
                        display: true,
                        text: 'Time',
                        color: '#94a3b8',
                        font: { size: 11, weight: 'bold' }
                    }
                }
            }
        }
    });

    charts.status = new Chart(document.getElementById('statusChart'), {
        type: 'doughnut',
        data: {
            labels: [],
            datasets: [{
                data: [],
                backgroundColor: ['#10b981', '#f59e0b', '#ef4444', '#3b82f6'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom', labels: { color: '#e2e8f0', font: { size: 11 }, padding: 12 } }
            }
        }
    });

    // Success Rate Chart (grouped bar: 1h vs 5m per operator)
    charts.successRate = new Chart(document.getElementById('successRateChart'), {
        type: 'bar',
        data: {
            labels: [],
            datasets: [
                {
                    label: 'Last 1 Hour',
                    data: [],
                    backgroundColor: '#10b981',
                    borderRadius: 6,
                    borderWidth: 2,
                    borderColor: '#059669'
                },
                {
                    label: 'Last 5 Min',
                    data: [],
                    backgroundColor: '#fbbf24',
                    borderRadius: 6,
                    borderWidth: 2,
                    borderColor: '#f59e0b'
                }
            ]
        },
        options: { 
            ...chartConfig,
            scales: {
                ...chartConfig.scales,
                y: {
                    ...chartConfig.scales.y,
                    title: { display: true, text: 'Success Rate (%)', color: '#94a3b8', font: { size: 11, weight: 'bold' } }
                }
            }
        }
    });

    // Retry Rate Chart
    charts.retryRate = new Chart(document.getElementById('retryRateChart'), {
        type: 'bar',
        data: {
            labels: [],
            datasets: [
                {
                    label: 'Last 1 Hour',
                    data: [],
                    backgroundColor: '#ef4444',
                    borderRadius: 6,
                    borderWidth: 2,
                    borderColor: '#dc2626'
                },
                {
                    label: 'Last 5 Min',
                    data: [],
                    backgroundColor: '#fb923c',
                    borderRadius: 6,
                    borderWidth: 2,
                    borderColor: '#f97316'
                }
            ]
        },
        options: { 
            ...chartConfig,
            scales: {
                ...chartConfig.scales,
                y: {
                    ...chartConfig.scales.y,
                    title: { display: true, text: 'Retry Rate (%)', color: '#94a3b8', font: { size: 11, weight: 'bold' } }
                }
            }
        }
    });

    // Submit Delay Chart
    charts.submitDelay = new Chart(document.getElementById('submitDelayChart'), {
        type: 'bar',
        data: {
            labels: [],
            datasets: [
                {
                    label: 'Last 1 Hour',
                    data: [],
                    backgroundColor: '#6366f1',
                    borderRadius: 6,
                    borderWidth: 2,
                    borderColor: '#4f46e5'
                },
                {
                    label: 'Last 5 Min',
                    data: [],
                    backgroundColor: '#10b981',
                    borderRadius: 6,
                    borderWidth: 2,
                    borderColor: '#06b6d4'
                }
            ]
        },
        options: { 
            ...chartConfig,
            scales: {
                ...chartConfig.scales,
                y: {
                    ...chartConfig.scales.y,
                    title: { display: true, text: 'Submit Delay (ms)', color: '#94a3b8', font: { size: 11, weight: 'bold' } }
                }
            }
        }
    });

    // DR Delay Chart
    charts.drDelay = new Chart(document.getElementById('drDelayChart'), {
        type: 'bar',
        data: {
            labels: [],
            datasets: [
                {
                    label: 'Last 1 Hour',
                    data: [],
                    backgroundColor: '#8b5cf6',
                    borderRadius: 6,
                    borderWidth: 2,
                    borderColor: '#7c3aed'
                },
                {
                    label: 'Last 5 Min',
                    data: [],
                    backgroundColor: '#ec4899',
                    borderRadius: 6,
                    borderWidth: 2,
                    borderColor: '#db2777'
                }
            ]
        },
        options: { 
            ...chartConfig,
            scales: {
                ...chartConfig.scales,
                y: {
                    ...chartConfig.scales.y,
                    title: { display: true, text: 'DR Delay (ms)', color: '#94a3b8', font: { size: 11, weight: 'bold' } }
                }
            }
        }
    });

    // Update dashboard
    async function update() {
        const refresh = document.getElementById('refresh');
        refresh.classList.add('active');
        refresh.textContent = 'Refreshing...';

        try {
            const res = await fetch(`${API}/dashboard`);
            const data = await res.json();

            // Stats
            const o = data.overview || {};
            const status = o.messagesByStatus || {};
            document.getElementById('stats').innerHTML = `
                <div class="card stat" style="--accent: #10b981">
                    <div class="stat-label">Total Messages</div>
                    <div class="stat-value">${(o.totalMessages || 0).toLocaleString()}</div>
                    <div class="stat-info">📈 Today: ${o.messagesToday || 0}</div>
                </div>
                <div class="card stat" style="--accent: #3b82f6">
                    <div class="stat-label">Success Rate</div>
                    <div class="stat-value">${o.successRate || 0}%</div>
                    <div class="stat-info">⏱️ Last hour: ${o.messagesLastHour || 0}</div>
                </div>
                <div class="card stat" style="--accent: #f59e0b">
                    <div class="stat-label">Sessions</div>
                    <div class="stat-value">${o.activeSessions || 0}/${o.totalSessions || 0}</div>
                    <div class="stat-info">${o.activeSessions === o.totalSessions ? '✓ All active' : '⚠ Check status'}</div>
                </div>
                <div class="card stat" style="--accent: ${(status.QUEUED || 0) > 100 ? '#ef4444' : '#3b82f6'}">
                    <div class="stat-label">Queue Depth</div>
                    <div class="stat-value">${(status.QUEUED || 0).toLocaleString()}</div>
                    <div class="stat-info">${(status.QUEUED || 0) > 100 ? '⚠ High load' : '✓ Normal'}</div>
                </div>
            `;

            // Charts
            const t = data.throughput || {};
            const perMin = (t.messagesPerMinute || []).slice(0, 10).reverse();
            charts.throughput.data.labels = perMin.map(m => new Date(m.MINUTE).toLocaleTimeString());
            charts.throughput.data.datasets[0].data = perMin.map(m => m.COUNT);
            charts.throughput.update('none');

            if (status && Object.keys(status).length) {
                charts.status.data.labels = Object.keys(status);
                charts.status.data.datasets[0].data = Object.values(status);
            }
            charts.status.update('none');

            // Fetch and update per-operator performance metrics
            try {
                const perfRes = await fetch(`${API}/performance/operators`);
                const perfData = await perfRes.json();
                const operators = perfData.operators || [];
                
                const operatorLabels = operators.map(op => op.operator);
                
                // Success Rate
                charts.successRate.data.labels = operatorLabels;
                charts.successRate.data.datasets[0].data = operators.map(op => op.successRate1h);
                charts.successRate.data.datasets[1].data = operators.map(op => op.successRate5m);
                charts.successRate.update('none');
                
                // Retry Rate
                charts.retryRate.data.labels = operatorLabels;
                charts.retryRate.data.datasets[0].data = operators.map(op => op.retryRate1h);
                charts.retryRate.data.datasets[1].data = operators.map(op => op.retryRate5m);
                charts.retryRate.update('none');
                
                // Submit Delay
                charts.submitDelay.data.labels = operatorLabels;
                charts.submitDelay.data.datasets[0].data = operators.map(op => op.submitDelay1h);
                charts.submitDelay.data.datasets[1].data = operators.map(op => op.submitDelay5m);
                charts.submitDelay.update('none');
                
                // DR Delay
                charts.drDelay.data.labels = operatorLabels;
                charts.drDelay.data.datasets[0].data = operators.map(op => op.drDelay1h);
                charts.drDelay.data.datasets[1].data = operators.map(op => op.drDelay5m);
                charts.drDelay.update('none');
            } catch (err) {
                console.error('Error fetching operator performance:', err);
            }

            // Sessions
            document.getElementById('sessions').innerHTML = (data.sessions || []).map(s => {
                const status = s.status || 'UNKNOWN';
                const isStopped = status === 'STOPPED';
                const isConnected = status === 'CONNECTED';
                const isRetrying = status === 'RETRYING';
                const isStarting = status === 'STARTING';
                const isStopping = status === 'STOPPING';
                
                // Determine badge class
                let badgeClass = 'inactive';
                if (isConnected) badgeClass = 'active';
                
                // Determine button state
                let buttonDisabled = isStopping || isStarting;
                let buttonClass = isStopped ? 'btn-start' : 'btn-stop';
                let buttonText = isStopped ? 'Start' : 'Stop';
                
                if (isStopping) buttonText = 'Stopping...';
                if (isStarting) buttonText = 'Starting...';
                
                return `
                <div class="session card">
                    <div class="session-badge ${badgeClass}"></div>
                    <div class="session-info">
                        <div class="session-name">${s.sessionId}</div>
                        <div class="session-metrics">
                            <div>Status: <span class="badge badge-${isConnected ? 'success' : isRetrying ? 'warning' : isStopped ? 'danger' : 'info'}">${status}</span></div>
                            <div>Sent: <span>${s.metrics.SENT || 0}</span></div>
                            <div>Queued: <span>${s.metrics.QUEUED || 0}</span></div>
                            <div>Failed: <span>${s.metrics.FAILED || 0}</span></div>
                        </div>
                    </div>
                    <button class="btn ${buttonClass}" 
                            onclick="toggleSession('${s.sessionId}', ${!isStopped})"
                            ${buttonDisabled ? 'disabled' : ''}>
                        ${buttonText}
                    </button>
                </div>
                `;
            }).join('');

            // Activity
            document.getElementById('activity').innerHTML = (data.recentActivity || []).slice(0, 50).map(m => `
                <tr>
                    <td>${m.ID}</td>
                    <td>${m.MSISDN}</td>
                    <td>${m.PRIORITY}</td>
                    <td><span class="badge badge-${m.STATUS.toLowerCase() === 'sent' ? 'success' : m.STATUS.toLowerCase() === 'failed' ? 'danger' : m.STATUS.toLowerCase() === 'delivered' ? 'info' : 'warning'}">${m.STATUS}</span></td>
                    <td>${m.OPERATOR || 'N/A'}</td>
                    <td>${m.SESSION_ID || 'N/A'}</td>
                    <td>${new Date(m.CREATED_AT).toLocaleString()}</td>
                </tr>
            `).join('');

            // Alerts
            document.getElementById('alerts').innerHTML = (data.alerts || []).map(a => `
                <div class="alert alert-${a.severity.toLowerCase()}">
                    <div>
                        <strong>${a.type.replace(/_/g, ' ')}</strong>
                        <small>${a.message}</small>
                    </div>
                    <small>${new Date(a.timestamp).toLocaleTimeString()}</small>
                </div>
            `).join('');

            refresh.textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
        } catch (err) {
            console.error(err);
            refresh.textContent = 'Error';
        } finally {
            refresh.classList.remove('active');
        }
    }

    // Track pending session operations to prevent double-clicks
    const pendingOperations = new Set();

    async function toggleSession(id, active) {
        // Debounce: prevent multiple simultaneous requests for same session
        if (pendingOperations.has(id)) {
            console.log(`Operation already in progress for ${id}`);
            return;
        }

        pendingOperations.add(id);
        
        try {
            const action = active ? 'stop' : 'start';
            const res = await fetch(`${API}/session/${id}/${action}`, { method: 'POST' });
            const result = await res.json();
            
            // Show toast notification instead of alert
            showToast(result.success ? 'success' : 'error', result.message || `Session ${action} ${result.success ? 'successful' : 'failed'}`);
            
            // Immediately update to show new state
            update();
        } catch (err) {
            console.error('Session toggle error:', err);
            showToast('error', 'Failed to toggle session: ' + err.message);
        } finally {
            // Remove from pending after a short delay to prevent rapid re-clicks
            setTimeout(() => pendingOperations.delete(id), 1000);
        }
    }

    // Toast notification system
    function showToast(type, message) {
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.textContent = message;
        document.body.appendChild(toast);
        
        // Trigger animation
        setTimeout(() => toast.classList.add('show'), 10);
        
        // Remove after 3 seconds
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    update();
    setInterval(update, 5000);
</script>
</body>
</html>